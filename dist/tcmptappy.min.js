!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Tappy=t()}(this,function(){var e=function(e,t){this.name=e,this.methods=[];for(var r=0;r<t.length;r++){if("string"!=typeof t[r])throw new Error("Interface methods must be strings");this.methods.push(t[r])}};e.prototype={getName:function(){return this.name},getMethods:function(){return this.methods}},e.iInterface=new e("iInterface",["getName","getMethods"]),e.hasMethod=function(e,t){return!(!e[t]||"function"!=typeof e[t])},e.check=function(t){if(arguments.length<2)throw new Error("Must specify an instance as well as 1 or more interfaces to check");for(var r=1;r<arguments.length;r++)for(var n=arguments[r],o=n.getMethods(),i=0;i<o.length;i++){var s=o[i];if(!e.hasMethod(t,s))return!1}return!0},e.typeErrorString=function(t){if(arguments.length<2)throw new Error("Must specify at least one instance and one interface");for(var r="Error, object "+t.toString()+" must implement: ",n=1;n<arguments.length;n++){var o=arguments[n];if(!e.check(o,e.iInterface))throw new Error("Must check against Interfaces");for(var i=o.getMethods(),s=[],a=[],c=0;c<i.length;c++)a.push(i[c]),e.hasMethod(t,i[c])||s.push(i[c]);s.length>0&&(r+="\n	"+o.getName()+" missing methods:\n		",r+=s.join("\n		"))}return r};var t=new e("iCommunicator",["connect","disconnect","isConnected","flush","setDataCallback","setErrorCallback","send"]),r=new e("iTcmpMessage",["getCommandFamily","getCommandCode","getPayload"]),n=function(e,t){var r=0,n=0,o=0;for(n=255&(e^t),r=0;8>r;r++)o=0!==(1&(o^n))?o>>1^33800:o>>1,n>>=1;return 65535&(e>>8^o)},o=function(e){for(var t=25443,r=0;r<e.length;++r)t=n(t,e[r]);return[t>>8&255,255&t]},i=function(e,t,r){var n=r.length+5,i=n>>8&255,s=255&n,a=255-((255&i)+(255&s)&255)+1&255,c=new Uint8Array(r.length+6);c[0]=i,c[1]=s,c[2]=a,c[3]=e[0],c[4]=e[1],c[5]=t;for(var u=0;u<r.length;u++)c[6+u]=r[u];var h=o(c),f=new Uint8Array(c.length+2);return f.set(c),f[c.length]=h[0],f[c.length+1]=h[1],f},s=function(e){var t=function(e,t,r){this.family=new Uint8Array(e),this.code=t,this.payload=new Uint8Array(r),this.getCommandFamily=function(){return this.family},this.getCommandCode=function(){return this.code},this.getPayload=function(){return this.payload}};if(e.length<8)return{msg:null,ok:!1,err:"Too short"};var r=e[0],n=e[1],i=e[2],s=[e[3],e[4]],a=e[5],c=[e[e.length-2],e[e.length-1]],u=e.slice(0,e.length-2),h=o(u);if(c[0]!==h[0]||c[1]!==h[1])return{msg:null,ok:!1,err:"Bad CRC"};var f=255-((255&r)+(255&n)&255)+1&255;if(f!=i)return{msg:null,ok:!1,err:"Bad LCS"};var m=(r<<8)+n;if(m!==e.length-3)return{msg:null,ok:!1,err:"Bad length, read "+m+" found "+(e.length-5)};var l=e.slice(6,e.length-2);return{msg:new t(s,a,l),ok:!0,err:null}},a=function(e){for(var t=[126],r=0;r<e.length;r++)126===e[r]?(t.push(125),t.push(94)):125===e[r]?(t.push(125),t.push(93)):t.push(e[r]);return t.push(126),new Uint8Array(t)},c=function(e){for(var t=[],r=!0,n=0;n<e.length;n++)if(126===e[n]);else if(125===e[n]){if(n+1>e.length){r=!1;break}if(93===e[n+1])t.push(125),n++;else{if(94!==e[n+1]){r=!1;break}t.push(126),n++}}else t.push(e[n]);return{unescaped:new Uint8Array(t),ok:r}},u=function(e,t){return"object"==typeof e&&null!==e&&"undefined"!=typeof e[t]},h=function(e,t,r){return u(e,t)?e[t]:r},f=function(r){var n=this;if(!u(r,"communicator"))throw new Error("Must supply a communicator");var o=r.communicator;if(!e.check(o,t))throw new Error(e.typeErrorString(o,t));this.communicator=o,this.messageListener=h(r,"messageListener",function(){}),this.errorListener=h(r,"errorListener",function(){}),this.buffer=[],this.dataCb=function(e){for(var t=new Uint8Array(e),r=0;r<t.length;r++)if(n.buffer.push(t[r]),126===t[r]){var o=n.buffer;n.buffer=[];var i=c(o);if(i.ok){if(i.unescaped.length>0){var a=s(i.unescaped);a.ok?n.messageListener(a.msg):n.errorListener(f.ErrorType.INVALID_TCMP,{packet:o,message:i.unescaped})}}else n.errorListener(f.ErrorType.INVALID_HDLC,{packet:o})}},this.commErrorCb=function(e){this.errorListener(f.ErrorType.CONNECTION_ERROR,e)},this.communicator.setDataCallback(this.dataCb),this.communicator.setErrorCallback(this.commErrorCb)};return f.ErrorType={NOT_CONNECTED:0,CONNECTION_ERROR:1,INVALID_HDLC:2,INVALID_TCMP:3},f.prototype={setMessageListener:function(e){this.messageListener=e},sendMessage:function(t){var n=e.check(t,r);if(!n)throw new Error(e.typeErrorString(t,r));if(this.communicator.isConnected()){var o=i(t.getCommandFamily(),t.getCommandCode(),t.getPayload()),s=a(o);this.communicator.send(s.buffer)}else this.errorListener(f.ErrorType.NOT_CONNECTED)},setErrorListener:function(e){this.errorListener=e},connect:function(e){this.communicator.connect(e)},disconnect:function(e){this.communicator.disconnect(e)},isConnected:function(){return this.communicator.isConnected()}},f});