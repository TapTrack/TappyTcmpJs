!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Tappy=t()}(this,function(){function c(e,t){this.name=e,this.methods=[];for(var n=0;n<t.length;n++){if("string"!=typeof t[n])throw new Error("Interface methods must be strings");this.methods.push(t[n])}}c.prototype={getName:function(){return this.name},getMethods:function(){return this.methods}},c.iInterface=new c("iInterface",["getName","getMethods"]),c.hasMethod=function(e,t){return!(!e[t]||"function"!=typeof e[t])},c.check=function(e){if(arguments.length<2)throw new Error("Must specify an instance as well as 1 or more interfaces to check");for(var t=1;t<arguments.length;t++)for(var n=arguments[t].getMethods(),r=0;r<n.length;r++){var o=n[r];if(!c.hasMethod(e,o))return!1}return!0},c.typeErrorString=function(e){if(arguments.length<2)throw new Error("Must specify at least one instance and one interface");for(var t="Error, object "+e.toString()+" must implement: ",n=1;n<arguments.length;n++){var r=arguments[n];if(!c.check(r,c.iInterface))throw new Error("Must check against Interfaces");for(var o=r.getMethods(),s=[],i=[],a=0;a<o.length;a++)i.push(o[a]),c.hasMethod(e,o[a])||s.push(o[a]);0<s.length&&(t+="\n\t"+r.getName()+" missing methods:\n\t\t",t+=s.join("\n\t\t"))}return t};function f(e){for(var t=25443,n=0;n<e.length;++n)t=function(e,t){for(var n=0,r=0,o=0,r=255&(e^t),n=0;n<8;n++)o=0!=(1&(o^r))?o>>1^33800:o>>1,r>>=1;return 65535&(e>>8^o)}(t,e[n]);return[t>>8&255,255&t]}function g(e,t,n){var r=new Uint8Array(e),o=t,s=new Uint8Array(n);this.getCommandFamily=function(){return r},this.getCommandCode=function(){return o},this.getPayload=function(){return s}}function r(e,t){return"object"==typeof e&&null!==e&&void 0!==e[t]}function n(e,t,n){return r(e,t)?e[t]:n}var o=new c("iCommunicator",["connect","disconnect","isConnected","flush","setDataCallback","setErrorCallback","send"]),s=new c("iTcmpMessage",["getCommandFamily","getCommandCode","getPayload"]),a=function(e){var i=this;if(!r(e,"communicator"))throw new Error("Must supply a communicator");var t=e.communicator;if(!c.check(t,o))throw new Error(c.typeErrorString(t,o));this.communicator=t,this.messageListener=n(e,"messageListener",function(){}),this.errorListener=n(e,"errorListener",function(){}),this.buffer=[],this.dataCb=function(e){for(var t,n,r,o=new Uint8Array(e),s=0;s<o.length;s++){i.buffer.push(o[s]),126===o[s]&&(t=i.buffer,i.buffer=[],(n=function(e){for(var t=[],n=!0,r=0;r<e.length;r++)if(126!==e[r])if(125===e[r]){if(r+1>e.length){n=!1;break}if(93===e[r+1])t.push(125),r++;else{if(94!==e[r+1]){n=!1;break}t.push(126),r++}}else t.push(e[r]);return{unescaped:new Uint8Array(t),ok:n}}(t)).ok?0<n.unescaped.length&&((r=function(e){if(e.length<8)return{msg:null,ok:!1,err:"Too short"};var t=e[0],n=e[1],r=e[2],o=[e[3],e[4]],s=e[5],i=[e[e.length-2],e[e.length-1]],a=e.slice(0,e.length-2),c=f(a);if(i[0]!==c[0]||i[1]!==c[1])return{msg:null,ok:!1,err:"Bad CRC"};if((255-((255&t)+(255&n)&255)+1&255)!=r)return{msg:null,ok:!1,err:"Bad LCS"};var u=(t<<8)+n;if(u!==e.length-3)return{msg:null,ok:!1,err:"Bad length, read "+u+" found "+(e.length-5)};var h=e.slice(6,e.length-2);return{msg:new g(o,s,h),ok:!0,err:null}}(n.unescaped)).ok?i.messageListener(r.msg):i.errorListener(a.ErrorType.INVALID_TCMP,{packet:t,message:n.unescaped})):i.errorListener(a.ErrorType.INVALID_HDLC,{packet:t}))}},this.commErrorCb=function(e){i.errorListener(a.ErrorType.CONNECTION_ERROR,e)},this.communicator.setDataCallback(this.dataCb),this.communicator.setErrorCallback(this.commErrorCb)};a.ErrorType={NOT_CONNECTED:0,CONNECTION_ERROR:1,INVALID_HDLC:2,INVALID_TCMP:3},a.prototype={setMessageListener:function(e){this.messageListener=e},sendMessage:function(e){var t;if(!c.check(e,s))throw new Error(c.typeErrorString(e,s));this.isConnected()?(t=function(e){for(var t=[126],n=0;n<e.length;n++)126===e[n]?(t.push(125),t.push(94)):125===e[n]?(t.push(125),t.push(93)):t.push(e[n]);return t.push(126),new Uint8Array(t)}(function(e,t,n){var r=n.length+5,o=r>>8&255,s=255&r,i=255-((255&o)+(255&s)&255)+1&255,a=new Uint8Array(n.length+6);a[0]=o,a[1]=s,a[2]=i,a[3]=e[0],a[4]=e[1],a[5]=t;for(var c=0;c<n.length;c++)a[6+c]=n[c];var u=f(a),h=new Uint8Array(a.length+2);return h.set(a),h[a.length]=u[0],h[a.length+1]=u[1],h}(e.getCommandFamily(),e.getCommandCode(),e.getPayload())),this.communicator.send(t.buffer)):this.errorListener(a.ErrorType.NOT_CONNECTED)},setErrorListener:function(e){this.errorListener=e},connect:function(e){this.communicator.connect(e)},disconnect:function(e){this.communicator.disconnect(e)},isConnected:function(){return this.communicator.isConnected()}};function e(e,t,n,r,o){this.id=e,this.forumType=t,this.description=n,this.safeCapacity=r,this.maxCapacity=o}return a.tagTypes=[],a.tagTypes[0]=new e(0,0,"Unknown tag technology",0,0),a.tagTypes[1]=new e(1,2,"MIFARE Ultralight",48,128),a.tagTypes[2]=new e(2,2,"NTAG 203",144,144),a.tagTypes[3]=new e(3,2,"MIFARE Ultralight C",48,48),a.tagTypes[4]=new e(4,-1,"MIFARE Classic 1k",1024,1024),a.tagTypes[5]=new e(5,-1,"MIFARE Classic 4k",4096,4096),a.tagTypes[6]=new e(6,4,"MIFARE DESFire EV1 4k",4096,4096),a.tagTypes[7]=new e(7,2,"Generic NFC Forum Type 2",48,888),a.tagTypes[8]=new e(8,-1,"MIFARE Plus 2k CL2",2048,2048),a.tagTypes[9]=new e(9,-1,"MIFARE Plus 4k CL2",4096,4096),a.tagTypes[10]=new e(10,-1,"MIFARE Mini",320,320),a.tagTypes[11]=new e(11,4,"Generic NFC Forum Type 4",256,8192),a.tagTypes[12]=new e(12,4,"MIFARE DESFire EV1 4k",4096,4096),a.tagTypes[13]=new e(13,4,"MIFARE DESFire EV1 8k",8192,8192),a.tagTypes[14]=new e(14,4,"MIFARE DESFire - Unspecified model/capacity",256,8192),a.tagTypes[15]=new e(15,1,"Topaz 512",454,454),a.tagTypes[16]=new e(16,2,"NTAG 210",48,48),a.tagTypes[17]=new e(17,2,"NTAG 212",128,128),a.tagTypes[18]=new e(18,2,"NTAG 213",144,144),a.tagTypes[19]=new e(19,2,"NTAG 215",504,504),a.tagTypes[20]=new e(20,2,"NTAG 216",888,888),a.resolveTagType=function(e){return void 0!==a.tagTypes[e]?a.tagTypes[e]:null},a});