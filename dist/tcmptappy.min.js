!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Tappy=t()}(this,function(){var e=function(e,t){this.name=e,this.methods=[];for(var n=0;n<t.length;n++){if("string"!=typeof t[n])throw new Error("Interface methods must be strings");this.methods.push(t[n])}};e.prototype={getName:function(){return this.name},getMethods:function(){return this.methods}},e.iInterface=new e("iInterface",["getName","getMethods"]),e.hasMethod=function(e,t){return!(!e[t]||"function"!=typeof e[t])},e.check=function(t){if(arguments.length<2)throw new Error("Must specify an instance as well as 1 or more interfaces to check");for(var n=1;n<arguments.length;n++)for(var r=arguments[n],o=r.getMethods(),s=0;s<o.length;s++){var i=o[s];if(!e.hasMethod(t,i))return!1}return!0},e.typeErrorString=function(t){if(arguments.length<2)throw new Error("Must specify at least one instance and one interface");for(var n="Error, object "+t.toString()+" must implement: ",r=1;r<arguments.length;r++){var o=arguments[r];if(!e.check(o,e.iInterface))throw new Error("Must check against Interfaces");for(var s=o.getMethods(),i=[],a=[],c=0;c<s.length;c++)a.push(s[c]),e.hasMethod(t,s[c])||i.push(s[c]);i.length>0&&(n+="\n	"+o.getName()+" missing methods:\n		",n+=i.join("\n		"))}return n};var t=new e("iCommunicator",["connect","disconnect","isConnected","flush","setDataCallback","setErrorCallback","send"]),n=new e("iTcmpMessage",["getCommandFamily","getCommandCode","getPayload"]),r=function(e,t){var n=0,r=0,o=0;for(r=255&(e^t),n=0;8>n;n++)o=0!==(1&(o^r))?o>>1^33800:o>>1,r>>=1;return 65535&(e>>8^o)},o=function(e){for(var t=25443,n=0;n<e.length;++n)t=r(t,e[n]);return[t>>8&255,255&t]},s=function(e,t,n){var r=n.length+5,s=r>>8&255,i=255&r,a=255-((255&s)+(255&i)&255)+1&255,c=new Uint8Array(n.length+6);c[0]=s,c[1]=i,c[2]=a,c[3]=e[0],c[4]=e[1],c[5]=t;for(var u=0;u<n.length;u++)c[6+u]=n[u];var h=o(c),f=new Uint8Array(c.length+2);return f.set(c),f[c.length]=h[0],f[c.length+1]=h[1],f},i=function(e,t,n){var r=new Uint8Array(e),o=t,s=new Uint8Array(n);this.getCommandFamily=function(){return r},this.getCommandCode=function(){return o},this.getPayload=function(){return s}},a=function(e){if(e.length<8)return{msg:null,ok:!1,err:"Too short"};var t=e[0],n=e[1],r=e[2],s=[e[3],e[4]],a=e[5],c=[e[e.length-2],e[e.length-1]],u=e.slice(0,e.length-2),h=o(u);if(c[0]!==h[0]||c[1]!==h[1])return{msg:null,ok:!1,err:"Bad CRC"};var f=255-((255&t)+(255&n)&255)+1&255;if(f!=r)return{msg:null,ok:!1,err:"Bad LCS"};var g=(t<<8)+n;if(g!==e.length-3)return{msg:null,ok:!1,err:"Bad length, read "+g+" found "+(e.length-5)};var p=e.slice(6,e.length-2);return{msg:new i(s,a,p),ok:!0,err:null}},c=function(e){for(var t=[126],n=0;n<e.length;n++)126===e[n]?(t.push(125),t.push(94)):125===e[n]?(t.push(125),t.push(93)):t.push(e[n]);return t.push(126),new Uint8Array(t)},u=function(e){for(var t=[],n=!0,r=0;r<e.length;r++)if(126===e[r]);else if(125===e[r]){if(r+1>e.length){n=!1;break}if(93===e[r+1])t.push(125),r++;else{if(94!==e[r+1]){n=!1;break}t.push(126),r++}}else t.push(e[r]);return{unescaped:new Uint8Array(t),ok:n}},h=function(e,t){return"object"==typeof e&&null!==e&&"undefined"!=typeof e[t]},f=function(e,t,n){return h(e,t)?e[t]:n},g=function(n){var r=this;if(!h(n,"communicator"))throw new Error("Must supply a communicator");var o=n.communicator;if(!e.check(o,t))throw new Error(e.typeErrorString(o,t));this.communicator=o,this.messageListener=f(n,"messageListener",function(){}),this.errorListener=f(n,"errorListener",function(){}),this.buffer=[],this.dataCb=function(e){for(var t=new Uint8Array(e),n=0;n<t.length;n++)if(r.buffer.push(t[n]),126===t[n]){var o=r.buffer;r.buffer=[];var s=u(o);if(s.ok){if(s.unescaped.length>0){var i=a(s.unescaped);i.ok?r.messageListener(i.msg):r.errorListener(g.ErrorType.INVALID_TCMP,{packet:o,message:s.unescaped})}}else r.errorListener(g.ErrorType.INVALID_HDLC,{packet:o})}},this.commErrorCb=function(e){r.errorListener(g.ErrorType.CONNECTION_ERROR,e)},this.communicator.setDataCallback(this.dataCb),this.communicator.setErrorCallback(this.commErrorCb)};g.ErrorType={NOT_CONNECTED:0,CONNECTION_ERROR:1,INVALID_HDLC:2,INVALID_TCMP:3},g.prototype={setMessageListener:function(e){var t=this;t.messageListener=e},sendMessage:function(t){var r=this,o=e.check(t,n);if(!o)throw new Error(e.typeErrorString(t,n));if(r.isConnected()){var i=s(t.getCommandFamily(),t.getCommandCode(),t.getPayload()),a=c(i);r.communicator.send(a.buffer)}else r.errorListener(g.ErrorType.NOT_CONNECTED)},setErrorListener:function(e){var t=this;t.errorListener=e},connect:function(e){var t=this;t.communicator.connect(e)},disconnect:function(e){var t=this;t.communicator.disconnect(e)},isConnected:function(){var e=this;return e.communicator.isConnected()}};var p=function(e,t,n,r,o){this.id=e,this.forumType=t,this.description=n,this.safeCapacity=r,this.maxCapacity=o};return g.tagTypes=[],g.tagTypes[0]=new p(0,0,"Unknown tag technology",0,0),g.tagTypes[1]=new p(1,2,"MIFARE Ultralight",48,128),g.tagTypes[2]=new p(2,2,"NTAG 203",144,144),g.tagTypes[3]=new p(3,2,"MIFARE Ultralight C",48,48),g.tagTypes[4]=new p(4,-1,"MIFARE Classic 1k",1024,1024),g.tagTypes[5]=new p(5,-1,"MIFARE Classic 4k",4096,4096),g.tagTypes[6]=new p(6,4,"MIFARE DESFire EV1 4k",4096,4096),g.tagTypes[7]=new p(7,2,"Generic NFC Forum Type 2",48,888),g.tagTypes[8]=new p(8,-1,"MIFARE Plus 2k CL2",2048,2048),g.tagTypes[9]=new p(9,-1,"MIFARE Plus 4k CL2",4096,4096),g.tagTypes[10]=new p(10,-1,"MIFARE Mini",320,320),g.tagTypes[11]=new p(11,4,"Generic NFC Forum Type 4",256,8192),g.tagTypes[12]=new p(12,4,"MIFARE DESFire EV1 4k",4096,4096),g.tagTypes[13]=new p(13,4,"MIFARE DESFire EV1 8k",8192,8192),g.tagTypes[14]=new p(14,4,"MIFARE DESFire - Unspecified model/capacity",256,8192),g.tagTypes[15]=new p(15,1,"Topaz 512",454,454),g.tagTypes[16]=new p(16,2,"NTAG 210",48,48),g.tagTypes[17]=new p(17,2,"NTAG 212",128,128),g.tagTypes[18]=new p(18,2,"NTAG 213",144,144),g.tagTypes[19]=new p(19,2,"NTAG 215",504,504),g.tagTypes[20]=new p(20,2,"NTAG 216",888,888),g.resolveTagType=function(e){return"undefined"!=typeof g.tagTypes[e]?g.tagTypes[e]:null},g});