!function(e,r){"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?module.exports=r():e.Tappy=r()}(this,function(){var e=function(e,r){this.name=e,this.methods=[];for(var t=0;t<r.length;t++){if("string"!=typeof r[t])throw new Error("Interface methods must be strings");this.methods.push(r[t])}};e.prototype={getName:function(){return this.name},getMethods:function(){return this.methods}},e.iInterface=new e("iInterface",["getName","getMethods"]),e.hasMethod=function(e,r){return!(!e[r]||"function"!=typeof e[r])},e.check=function(r){if(arguments.length<2)throw new Error("Must specify an instance as well as 1 or more interfaces to check");for(var t=1;t<arguments.length;t++)for(var n=arguments[t],o=n.getMethods(),i=0;i<o.length;i++){var s=o[i];if(!e.hasMethod(r,s))return!1}return!0},e.typeErrorString=function(r){if(arguments.length<2)throw new Error("Must specify at least one instance and one interface");for(var t="Error, object "+r.toString()+" must implement: ",n=1;n<arguments.length;n++){var o=arguments[n];if(!e.check(o,e.iInterface))throw new Error("Must check against Interfaces");for(var i=o.getMethods(),s=[],a=[],c=0;c<i.length;c++)a.push(i[c]),e.hasMethod(r,i[c])||s.push(i[c]);s.length>0&&(t+="\n	"+o.getName()+" missing methods:\n		",t+=s.join("\n		"))}return t};var r=new e("iCommunicator",["connect","disconnect","isConnected","flush","setDataCallback","setErrorCallback","send"]),t=new e("iTcmpMessage",["getCommandFamily","getCommandCode","getPayload"]),n=function(e,r){var t=0,n=0,o=0;for(n=255&(e^r),t=0;8>t;t++)o=0!==(1&(o^n))?o>>1^33800:o>>1,n>>=1;return 65535&(e>>8^o)},o=function(e){for(var r=25443,t=0;t<e.length;++t)r=n(r,e[t]);return[r>>8&255,255&r]},i=function(e,r,t){var n=t.length+5,i=n>>8&255,s=255&n,a=255-((255&i)+(255&s)&255)+1&255,c=new Uint8Array(t.length+6);c[0]=i,c[1]=s,c[2]=a,c[3]=e[0],c[4]=e[1],c[5]=r;for(var u=0;u<t.length;u++)c[6+u]=t[u];var h=o(c),f=new Uint8Array(c.length+2);return f.set(c),f[c.length]=h[0],f[c.length+1]=h[1],f},s=function(e,r,t){var n=new Uint8Array(e),o=r,i=new Uint8Array(t);this.getCommandFamily=function(){return n},this.getCommandCode=function(){return o},this.getPayload=function(){return i}},a=function(e){if(e.length<8)return{msg:null,ok:!1,err:"Too short"};var r=e[0],t=e[1],n=e[2],i=[e[3],e[4]],a=e[5],c=[e[e.length-2],e[e.length-1]],u=e.slice(0,e.length-2),h=o(u);if(c[0]!==h[0]||c[1]!==h[1])return{msg:null,ok:!1,err:"Bad CRC"};var f=255-((255&r)+(255&t)&255)+1&255;if(f!=n)return{msg:null,ok:!1,err:"Bad LCS"};var m=(r<<8)+t;if(m!==e.length-3)return{msg:null,ok:!1,err:"Bad length, read "+m+" found "+(e.length-5)};var l=e.slice(6,e.length-2);return{msg:new s(i,a,l),ok:!0,err:null}},c=function(e){for(var r=[126],t=0;t<e.length;t++)126===e[t]?(r.push(125),r.push(94)):125===e[t]?(r.push(125),r.push(93)):r.push(e[t]);return r.push(126),new Uint8Array(r)},u=function(e){for(var r=[],t=!0,n=0;n<e.length;n++)if(126===e[n]);else if(125===e[n]){if(n+1>e.length){t=!1;break}if(93===e[n+1])r.push(125),n++;else{if(94!==e[n+1]){t=!1;break}r.push(126),n++}}else r.push(e[n]);return{unescaped:new Uint8Array(r),ok:t}},h=function(e,r){return"object"==typeof e&&null!==e&&"undefined"!=typeof e[r]},f=function(e,r,t){return h(e,r)?e[r]:t},m=function(t){var n=this;if(!h(t,"communicator"))throw new Error("Must supply a communicator");var o=t.communicator;if(!e.check(o,r))throw new Error(e.typeErrorString(o,r));this.communicator=o,this.messageListener=f(t,"messageListener",function(){}),this.errorListener=f(t,"errorListener",function(){}),this.buffer=[],this.dataCb=function(e){for(var r=new Uint8Array(e),t=0;t<r.length;t++)if(n.buffer.push(r[t]),126===r[t]){var o=n.buffer;n.buffer=[];var i=u(o);if(i.ok){if(i.unescaped.length>0){var s=a(i.unescaped);s.ok?n.messageListener(s.msg):n.errorListener(m.ErrorType.INVALID_TCMP,{packet:o,message:i.unescaped})}}else n.errorListener(m.ErrorType.INVALID_HDLC,{packet:o})}},this.commErrorCb=function(e){n.errorListener(m.ErrorType.CONNECTION_ERROR,e)},this.communicator.setDataCallback(this.dataCb),this.communicator.setErrorCallback(this.commErrorCb)};return m.ErrorType={NOT_CONNECTED:0,CONNECTION_ERROR:1,INVALID_HDLC:2,INVALID_TCMP:3},m.prototype={setMessageListener:function(e){var r=this;r.messageListener=e},sendMessage:function(r){var n=this,o=e.check(r,t);if(!o)throw new Error(e.typeErrorString(r,t));if(n.isConnected()){var s=i(r.getCommandFamily(),r.getCommandCode(),r.getPayload()),a=c(s);n.communicator.send(a.buffer)}else n.errorListener(m.ErrorType.NOT_CONNECTED)},setErrorListener:function(e){var r=this;r.errorListener=e},connect:function(e){var r=this;r.communicator.connect(e)},disconnect:function(e){var r=this;r.communicator.disconnect(e)},isConnected:function(){var e=this;return e.communicator.isConnected()}},m});